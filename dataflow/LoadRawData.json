{
	"name": "LoadRawData",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Sales_csv",
						"type": "DatasetReference"
					},
					"name": "RawSalesData"
				},
				{
					"name": "LoadStateAbbr",
					"description": "United States State Abbreviations"
				}
			],
			"sinks": [],
			"transformations": [
				{
					"name": "DeleteRowsCarModel",
					"description": "Delete Rows - Null Column Value in Car Make or Model"
				},
				{
					"name": "SplitModifyCols",
					"description": "Modify and split several columns"
				},
				{
					"name": "LookupStateCol"
				}
			],
			"scriptLines": [
				"source(output(",
				"          year as short,",
				"          make as string,",
				"          model as string,",
				"          trim as string,",
				"          body as string,",
				"          transmission as string,",
				"          vin as string,",
				"          state as string,",
				"          condition as short,",
				"          odometer as integer,",
				"          color as string,",
				"          interior as string,",
				"          seller as string,",
				"          mmr as integer,",
				"          sellingprice as integer,",
				"          saledate as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> RawSalesData",
				"source(output(",
				"          {Code } as string,",
				"          {Alpha code} as string,",
				"          alpha_code as string,",
				"          State as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false) ~> LoadStateAbbr",
				"LookupStateCol filter((!isNull(make) || make == '') || (!isNull(model) || model =='')) ~> DeleteRowsCarModel",
				"DeleteRowsCarModel derive(day_of_sale = iif(isNull(saledate) || saledate == '', 'Unknown', substring(saledate, 0, 4)),",
				"          sale_date = iif(isNull(saledate) || saledate == '', 'Unknown', substring(saledate, 4, 12)),",
				"          condition_rating = iif(condition >= 1 && condition <= 10, 'EXCELLENT',\r",
				"iif(condition >= 11 && condition <= 20, 'FINE',\r",
				"iif(condition >= 21 && condition <= 30, 'VERY GOOD',\r",
				"iif(condition >= 31 && condition <= 40, 'GOOD',\r",
				"iif(condition >= 41 && condition <= 50, 'RESTORABLE', 'UNKNOWN'))))),",
				"          transmission = iif(\r",
				"    isNull(transmission) || trim(transmission) == '' || lower(transmission) == 'sedan', \r",
				"    'Manual', \r",
				"    iif(lower(transmission) == 'automatic', 'Automatic', \r",
				"        concat(upper(substring(transmission, 0, 1)), substring(transmission, 1))\r",
				"    )\r",
				"),",
				"          color = iif(     \r",
				"    isNull(color) || trim(color) == '' || !isNull(color) && !regexMatch(lower(color), '^[a-z]+$'),     \r",
				"    'Neutral',    \r",
				"    initCap(color) ),",
				"          interior = iif(\r",
				"    isNull(interior) || trim(interior) == '' || !isNull(interior) && !regexMatch(lower(interior), '^[a-z]+$'),\r",
				"    'Neutral',\r",
				"    initCap(interior)\r",
				")) ~> SplitModifyCols",
				"RawSalesData, LoadStateAbbr lookup(RawSalesData@state == alpha_code,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> LookupStateCol"
			]
		}
	}
}